{% extends "layout.html" %}

{% block title %}Заявки на помощь{% endblock %}

{% block styles %}
<style>
    .request-card {
        transition: all 0.3s ease;
    }
    
    .request-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .badge-new {
        background-color: #ff5722;
        color: white;
    }
    
    .request-timestamp {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Заявки на помощь</h1>
    
    <div class="alert alert-success d-none" id="requests-alert"></div>
    
    <div id="requests-container">
        <!-- Здесь будут отображаться заявки -->
    </div>
    
    <div id="empty-state" style="display: none;" class="text-center mt-5">
        <i class="bi bi-inbox fs-1 text-muted"></i>
        <h3 class="mt-3">Нет активных заявок</h3>
        <p class="text-muted">Когда пользователи запросят помощь оператора, их заявки появятся здесь.</p>
    </div>
    
    <!-- Добавленный контейнер для отладочной информации -->
    <div id="debug-container" class="mt-4">
        <!-- Сюда будет добавлена отладочная информация -->
    </div>
</div>

<!-- Модальное окно для просмотра деталей заявки -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestModalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestModalTitle">Детали заявки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Пользователь:</label>
                    <div id="requestUsername">-</div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Email:</label>
                    <div id="requestEmail">-</div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Дата создания:</label>
                    <div id="requestDate">-</div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Количество сообщений:</label>
                    <div id="requestMessageCount">-</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-success" id="resolveRequestBtn">
                    <i class="bi bi-check-circle me-1"></i>
                    Отметить как решенную
                </button>
                <button type="button" class="btn btn-primary" id="goToChatBtn">
                    <i class="bi bi-chat-dots me-1"></i>
                    Перейти в чат
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // При загрузке страницы получаем список заявок
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Загрузка страницы заявок на помощь');
        loadRequests();
    });

    // Функция загрузки заявок
    async function loadRequests() {
        try {
            console.log('Начинаем загрузку заявок...');
            const requestsContainer = document.getElementById('requests-container');
            const emptyState = document.getElementById('empty-state');
            const requestsAlert = document.getElementById('requests-alert');
            
            // Показываем индикатор загрузки
            requestsContainer.innerHTML = '<div class="d-flex justify-content-center my-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
            
            // Запрашиваем заявки через API
            console.log('Вызываем API.getSupportRequests()');
            const requests = await API.getSupportRequests();
            console.log('Получены заявки:', requests);
            
            // Проверяем, есть ли заявки
            if (requests && requests.length > 0) {
                let requestsHTML = '';
                
                // Создаем карточки для каждой заявки
                requests.forEach(request => {
                    requestsHTML += createRequestCard(request);
                });
                
                // Отображаем заявки
                requestsContainer.innerHTML = requestsHTML;
                emptyState.style.display = 'none';
                
                // Добавляем обработчики событий для кнопок просмотра
                document.querySelectorAll('.view-request-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const requestId = this.getAttribute('data-request-id');
                        const request = requests.find(r => r.chat_id === requestId);
                        if (request) {
                            showRequestDetails(request);
                        }
                    });
                });
                
                // Показываем уведомление о количестве заявок
                requestsAlert.innerHTML = `<strong>Найдено ${requests.length} активных заявок</strong>`;
                requestsAlert.classList.remove('d-none');
            } else {
                // Если заявок нет, показываем empty state
                requestsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                requestsAlert.classList.add('d-none');
                
                console.log('Нет активных заявок');
                
                // Добавим проверку отладочного API
                try {
                    console.log('Проверяем отладочный API для заявок оператора...');
                    const debugResponse = await fetch('/api/debug/operator-requests', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API.token}`,
                        }
                    });
                    
                    if (debugResponse.ok) {
                        const debugData = await debugResponse.json();
                        console.log('Данные отладочного API:', debugData);
                        
                        // Отображаем отладочную информацию
                        const debugInfo = document.createElement('div');
                        debugInfo.className = 'alert alert-info mt-3';
                        debugInfo.innerHTML = `
                            <h4>Отладочная информация:</h4>
                            <p>Всего сообщений с метаданными: ${debugData.count}</p>
                            <p>Запросы оператора: ${debugData.messages.filter(m => m.is_operator_request).length}</p>
                            <p>Разрешенные запросы: ${debugData.messages.filter(m => m.is_resolved).length}</p>
                            <p>Активные запросы: ${debugData.messages.filter(m => m.is_operator_request && !m.is_resolved).length}</p>
                        `;
                        document.getElementById('debug-container').innerHTML = '';
                        document.getElementById('debug-container').appendChild(debugInfo);
                        
                        // Если есть сообщения с запросами операторов, отображаем их для отладки
                        if (debugData.messages.some(m => m.is_operator_request)) {
                            const debugTable = document.createElement('table');
                            debugTable.className = 'table table-striped table-sm mt-3';
                            debugTable.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Chat ID</th>
                                        <th>Сообщение</th>
                                        <th>Запрос оператора</th>
                                        <th>Разрешен</th>
                                        <th>Дата создания</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${debugData.messages.map(m => `
                                        <tr>
                                            <td>${m.id}</td>
                                            <td>${m.chat_id}</td>
                                            <td>${m.message}</td>
                                            <td>${m.is_operator_request ? '<span class="badge bg-success">Да</span>' : '<span class="badge bg-secondary">Нет</span>'}</td>
                                            <td>${m.is_resolved ? '<span class="badge bg-success">Да</span>' : '<span class="badge bg-warning">Нет</span>'}</td>
                                            <td>${new Date(m.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            `;
                            document.getElementById('debug-container').appendChild(debugTable);
                        }
                    }
                } catch (error) {
                    console.error('Ошибка получения отладочных данных:', error);
                }
            }
        } catch (error) {
            console.error('Ошибка при загрузке заявок:', error);
            document.getElementById('requests-container').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Ошибка!</strong> Не удалось загрузить заявки: ${error.message}
                </div>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', async function() {
        const requestsContainer = document.getElementById('requestsContainer');
        const emptyState = document.getElementById('emptyState');
        const modalUsername = document.getElementById('requestUsername');
        const modalTimestamp = document.getElementById('requestDate');
        const modalMessageCount = document.getElementById('requestMessageCount');
        const goToChatBtn = document.getElementById('goToChatBtn');
        const resolveRequestBtn = document.getElementById('resolveRequestBtn');
        const requestDetailsModal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
        
        let currentChatId = null;
        
        // Создание карточки заявки
        function createRequestCard(request) {
            // Форматируем дату
            const requestDate = new Date(request.created_at);
            const formattedDate = requestDate.toLocaleDateString() + ' ' + requestDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Создаем HTML карточки
            return `
                <div class="card mb-3 request-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-person-circle me-2"></i>
                                ${request.user.username}
                            </h5>
                            <span class="badge bg-primary rounded-pill">${request.message_count} сообщений</span>
                        </div>
                        <p class="card-text text-muted small mt-2">
                            <i class="bi bi-clock me-1"></i>
                            ${formattedDate}
                        </p>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-success">Новая заявка</span>
                            <button type="button" class="btn btn-sm btn-primary view-request-btn" data-request-id="${request.chat_id}">
                                <i class="bi bi-eye me-1"></i>
                                Просмотреть
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Отображение деталей заявки
        function showRequestDetails(request) {
            // Заполняем данные в модальном окне
            const modalTitle = document.getElementById('requestModalTitle');
            const requestUsername = document.getElementById('requestUsername');
            const requestEmail = document.getElementById('requestEmail');
            const requestDate = document.getElementById('requestDate');
            const requestMessageCount = document.getElementById('requestMessageCount');
            const chatBtn = document.getElementById('goToChatBtn');
            const resolveBtn = document.getElementById('resolveRequestBtn');
            
            // Форматируем дату
            const requestDateTime = new Date(request.created_at);
            const formattedDateTime = requestDateTime.toLocaleDateString() + ' ' + requestDateTime.toLocaleTimeString();
            
            // Заполняем элементы модального окна
            modalTitle.textContent = `Заявка от ${request.user.username}`;
            requestUsername.textContent = request.user.username;
            requestEmail.textContent = request.user.email || 'Email не указан';
            requestDate.textContent = formattedDateTime;
            requestMessageCount.textContent = request.message_count;
            
            // Устанавливаем ID чата для кнопок
            chatBtn.setAttribute('data-chat-id', request.chat_id);
            resolveBtn.setAttribute('data-chat-id', request.chat_id);
            
            // Добавляем обработчики событий для кнопок
            chatBtn.onclick = function() {
                window.location.href = `/chat/${request.chat_id}`;
            };
            
            resolveBtn.onclick = async function() {
                try {
                    const result = await API.resolveSupportRequest(request.chat_id);
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Заявка решена',
                            text: 'Заявка была успешно отмечена как решенная.',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            // Закрываем модальное окно и обновляем список заявок
                            const modal = bootstrap.Modal.getInstance(document.getElementById('requestDetailsModal'));
                            modal.hide();
                            loadRequests();
                        });
                    }
                } catch (error) {
                    console.error('Ошибка при разрешении заявки:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Не удалось разрешить заявку. Пожалуйста, попробуйте снова.'
                    });
                }
            };
            
            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
            modal.show();
        }
        
        // Обновить счетчик заявок в боковом меню
        function updateRequestCount(count) {
            const badge = document.querySelector('#support-requests-badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Устанавливаем интервал для периодического обновления списка заявок
        setInterval(loadRequests, 30000); // Обновляем каждые 30 секунд
    });
</script>
{% endblock %} 